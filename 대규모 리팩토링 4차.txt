================================================================================
[PIXELNIGHT] 최종 리팩토링 상세 기획서 (Version 4.0 - Final)
================================================================================
문서 번호: PN-REFACTOR-2026-FINAL
작성 일자: 2026-01-17
최종 목표: ECS 아키텍처 도입 및 기존 게임 플레이 로직(Game Rules & UX) 100% 보존

[경고]
이 문서는 단순한 구조 변경 제안서가 아닙니다. 
아래 명시된 '보존해야 할 핵심 로직'이 구현되지 않을 경우, 게임의 재미와 밸런스가 붕괴됩니다.
작업 시 이 문서를 절대적인 기준으로 삼으십시오.

--------------------------------------------------------------------------------
1. 아키텍처 철학 (Architecture Philosophy)
--------------------------------------------------------------------------------
*   **Hybrid ECS:** Python의 성능 한계를 고려하여, 순수 데이터 지향보다는 실용적인 ECS를 지향합니다.
    *   `Entity`: 고유 ID (int).
    *   `Component`: 데이터 클래스 (dataclass 권장).
    *   `System`: 로직 처리기.
    *   **Optimization:** 충돌 처리(`MapManager.collision_cache`), 렌더링(`Sprite Cache`), 길찾기(`Pathfinder`)는 별도 모듈/클래스로 유지하여 System이 이를 호출하는 방식을 사용합니다.

--------------------------------------------------------------------------------
2. 디렉토리 구조 (Directory Structure)
--------------------------------------------------------------------------------
/pixelnight
├── main.py                     # [Entry]
├── settings.py                 # [Config] 상수 보존 (PHASE_SETTINGS, SOUND_INFO 등)
├── colors.py                   # [Asset] 색상 팔레트
├── core/
│   ├── engine.py               # Main Loop
│   ├── ecs_manager.py          # [New] World/EntityManager
│   ├── event_bus.py            # [New] Pub/Sub Event System
│   ├── resource_manager.py     # [Asset] 폰트/이미지/사운드 로드 (Singleton)
│   └── game_state_manager.py   # [New] 전역 상태 (Blackout, Siren, News) 관리
├── components/                 # [Data]
│   ├── common.py               # Transform, Velocity, Sprite, Animation
│   ├── status.py               # Stats(HP/AP), StatusEffects(Pain/Anxiety), Identity
│   ├── interaction.py          # Inventory, Equipment, InteractionState
│   └── ai.py                   # AIBrain (BT Node 상태, Path, Target)
├── systems/                    # [Logic]
│   ├── time_system.py          # 시간, 날씨, 페이즈, 아침 생존 룰 처리
│   ├── input_system.py         # 키 입력 -> Intent 변환 (Long Press E 포함)
│   ├── movement_system.py      # 이동, 충돌체크, 문 끼임 방지
│   ├── ai_system.py            # BT 실행, 의심도 감소, 시야 감지
│   ├── interaction_system.py   # 타일/사물 상호작용, 미니게임 트리거
│   ├── sound_system.py         # 청각적/시각적 사운드 생성 (주관적 색상 처리)
│   └── render_system.py        # 맵, 엔티티, 조명(FOV), UI, 핀(Offscreen)
├── world/
│   ├── map_manager.py          # [Core] 타일맵 데이터, 충돌 캐시, 문 상태 관리
│   └── tiles.py                # 타일 속성 정의
├── ui/
│   ├── ui_manager.py           # UI 총괄
│   ├── hud.py                  # 상태바, 핀(Pin), 알림(Popup)
│   └── minigame_manager.py     # [Logic] 미니게임 로직 및 오버레이 렌더링
└── states/                     # [Scene]
    └── play_state.py           # ECS World 초기화 및 시스템 업데이트 루프

--------------------------------------------------------------------------------
3. 보존해야 할 핵심 로직 (Legacy Logic Preservation)
   *작업 시 반드시 체크리스트로 활용할 것*
--------------------------------------------------------------------------------

[3-1] 맵 및 환경 (Map & Environment)
1.  **충돌 최적화 (Collision Cache):** `MapManager`의 `collision_cache` (Boolean 2D Array)는 유지해야 합니다. 매 프레임 타일 속성을 조회하면 성능이 급격히 저하됩니다.
2.  **문 끼임 방지 (Door Safety):** `update_doors` 로직에서 문이 닫힐 때, **현재 문 위치에 살아있는 엔티티가 있으면 닫히지 않는 로직**을 `MovementSystem`이나 `MapManager`에 반드시 포함해야 합니다.
3.  **타일 쿨타임 (Tile Cooldown):** 작업(채집/채광) 후 해당 타일을 3초간 비활성화하는 로직.

[3-2] 시간 및 생존 룰 (Time & Survival) - `TimeSystem`
1.  **아침 정산 (Morning Process):**
    *   **집 보너스/페널티:** 실내(Indoor Zone)에서 자면 HP/AP +10, 밖이면 -30.
    *   **노동 할당량 (Quota):** 시민/의사는 하루 5회 작업 미달 시 HP -10.
    *   **작업 변경:** `(day_count - 1) % 3` 공식으로 매일 작업 타일 변경.
2.  **페이즈 보간 (Phase Interpolation):** `PHASE_SETTINGS`의 Alpha, Vision Factor, Clarity 값을 시간 흐름에 따라 **부드럽게 보간(Lerp)**하여 `RenderSystem`에 전달해야 합니다.

[3-3] 플레이어 및 상호작용 (Player & Interaction)
1.  **장단기 입력 구분 (Short vs Long Press):** 'E' 키 입력 시, 문 열기는 즉시(Short), 잠그기/해킹은 홀드(Long, 500ms 이상)로 구분하는 로직을 `InputSystem`에 구현해야 합니다.
2.  **아이템 효과 분기:** `use_item`의 모든 분기(회복, 스태미나 무한, 배터리 충전, 테이저건, 은신 등)를 `ItemSystem` 또는 `InteractionSystem`으로 완벽히 이식해야 합니다.
3.  **감정 시스템 (Emotion):**
    *   단순 상태값이 아닙니다. `NIGHT` 페이즈에 마피아와의 거리(Distance)에 따라 `ANXIETY`(심장박동) 레벨이 0~5단계로 변하는 로직이 필수입니다.

[3-4] AI 및 NPC (AI & NPC) - `AISystem`
1.  **의심도 자연 감소:** 아침마다 모든 NPC의 `suspicion_meter`가 30씩 감소해야 합니다.
2.  **유효 타일 이동:** 랜덤 이동 시 `MapManager.tile_cache`를 조회하여 **실제 이동 가능한 바닥**만 타겟으로 삼아야 합니다. (벽 속으로 이동 시도 금지)
3.  **시야 판단 (Role-Based Vision):** 경찰은 '빌런의 모습'(밤의 마피아)을 본 경우에만 추격해야 하며, 낮에는 추격하지 않아야 합니다.

[3-5] 렌더링 및 UI (Render & UI) - `RenderSystem`
1.  **주관적 사운드 시각화 (Subjective VisualSound):** 소리의 파장(VisualSound) 색상이 **플레이어의 직업**에 따라 다르게 보여야 합니다. (예: 마피아가 듣는 경찰 사이렌은 보라색/깜빡임).
2.  **오프스크린 핀 (Off-screen Pins):** 작업 목표가 화면 밖일 때 화면 가장자리에 화살표/박스를 그리는 로직.
3.  **컬링 (Culling):** `MapRenderer`처럼 화면에 보이는 타일만 그리는 최적화 필수.
4.  **동적 외형:** 마피아는 밤(`NIGHT`)에 자동으로 옷 색상이 변경되어 렌더링되어야 합니다.

[3-6] 미니게임 및 투표 (Minigame & Vote)
1.  **입력 제어권:** 미니게임 활성화 시 플레이어 이동/행동 입력을 차단해야 합니다.
2.  **동점자 처형 (Tie-Breaker):** 투표 최다 득표자가 동점일 경우, **무작위로 한 명을 처형**하는 로직을 유지해야 합니다.

--------------------------------------------------------------------------------
4. 컴포넌트 설계 상세 (Component Design)
--------------------------------------------------------------------------------
*모든 컴포넌트는 dataclass로 구현*

*   `Transform`: x, y, rotation, rect (pygame.Rect)
*   `Velocity`: dx, dy, speed_modifier
*   `Sprite`: role, sub_role, custom_data(skin/clothes/hat), visible, alpha
*   `Stats`: hp, max_hp, ap, max_ap, alive, coins
*   `StatusEffects`: emotions(dict), buffs(dict), sound_timers(dict)
*   `InputState`: moving_dir, intent_action, e_hold_start_time, flashlight_on
*   `AIBrain`: behavior_tree_state, target_entity_id, path_list, suspicion_data
*   `Inventory`: items(dict), equipped_item
*   `Identity`: name, role, sub_role, group_id(Player/Bot)
*   `Vision`: view_radius, is_blind (기면증 등)

--------------------------------------------------------------------------------
5. 단계별 구현 로드맵 (Implementation Roadmap)
--------------------------------------------------------------------------------

**Phase 1: Core Foundation (우선순위 최상)**
1.  `core/` 모듈 구현 (Engine, EventBus, ResourceManager, ECSManager).
2.  `components/` 기본 데이터 구조체 정의.
3.  `world/map_manager.py` 유지 및 ECS 연동 준비 (충돌 캐시 보존).
4.  `systems/render_system.py` 초기 구현 (맵 렌더링, 컬링 적용).

**Phase 2: Entity & Movement**
1.  `entities/factory.py` 구현 (Player/NPC 생성).
2.  `systems/input_system.py` & `movement_system.py` 구현.
3.  문 끼임 방지 로직 이식.

**Phase 3: Game Logic & AI**
1.  `systems/time_system.py`: 시간 흐름, 페이즈 보간, 아침 생존 룰 이식.
2.  `systems/ai_system.py`: BT 로직 분해 및 이식, 길찾기 연결.
3.  `systems/interaction_system.py`: 타일/사물 상호작용 및 쿨타임 처리.

**Phase 4: Advanced Systems**
1.  `systems/sound_system.py`: 주관적 시각화 로직 이식.
2.  `systems/render_system.py` 고도화: FOV 조명, 그라데이션 마스크 이식.
3.  `ui/minigame_manager.py` 통합: 미니게임 실행 및 보상 처리.

**Phase 5: UI & Final Polish**
1.  `ui/` 시스템 이식 (HUD, Minimap, Inventory, Vote).
2.  오프스크린 핀, 뉴스 로그, 전체적인 버그 수정.

================================================================================
이 문서는 프로젝트의 법전(Code Bible)입니다.
코드를 작성할 때마다 이 문서의 [3. 보존해야 할 핵심 로직]을 확인하십시오.
================================================================================